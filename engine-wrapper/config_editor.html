<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>ShogiHome LAN - Engine Config Editor</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --primary: #0d6efd;
            --danger: #dc3545;
            --success: #198754;
            --info: #0dcaf0;
            --warning: #ffc107;
            --border: #dee2e6;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #212529;
                --text-color: #f8f9fa;
                --card-bg: #343a40;
                --border: #495057;
            }
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1, h2, h3 { margin-top: 0; }
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            display: inline-block;
            font-weight: 400;
            text-align: center;
            vertical-align: middle;
            user-select: none;
            border: 1px solid transparent;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            border-radius: 0.25rem;
            cursor: pointer;
            text-decoration: none;
            background-color: #e9ecef;
            color: #000;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-info { background-color: var(--info); color: #000; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        input[type="text"], input[type="number"], select {
            display: block;
            width: 100%;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--bg-color);
            border: 1px solid var(--border);
            border-radius: 0.25rem;
            box-sizing: border-box;
        }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        th, td { padding: 0.75rem; border-top: 1px solid var(--border); text-align: left; }
        thead th { vertical-align: bottom; border-bottom: 2px solid var(--border); }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-footer {
            margin-top: 20px;
            text-align: right;
            border-top: 1px solid var(--border);
            padding-top: 15px;
        }
        .option-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            background: rgba(0,0,0,0.03);
            padding: 5px;
            border-radius: 4px;
        }
        .option-row input.opt-key { flex: 0 0 200px; }
        .option-row .opt-val-container { flex: 1; min-width: 0; display: flex; align-items: center; gap: 5px; }
        .option-row input.opt-val, .option-row select.opt-val { width: 100%; }
        
        .hint { font-size: 0.875rem; color: #6c757d; margin-top: 0.25rem; }
        .bool-label { margin-left: 5px; font-weight: bold; }
        
        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.7); display: flex;
            justify-content: center; align-items: center; z-index: 10;
        }
        @media (prefers-color-scheme: dark) {
            .loading-overlay { background: rgba(0,0,0,0.7); }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ShogiHome LAN 設定エディタ</h1>
    
    <!-- File Load Section (Visible only in File Mode) -->
    <div class="card" id="fileLoadSection">
        <h2>1. 読み込み</h2>
        <p>既存の <code>engines.json</code> を選択するか、新規作成してください。</p>
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="file" id="fileInput" accept=".json">
            <button class="btn" onclick="startNew()">新規作成</button>
        </div>
    </div>

    <div class="card" id="editorSection" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2>エンジン一覧</h2>
            <button class="btn btn-primary" onclick="openEngineModal()">+ エンジン追加</button>
        </div>
        <div class="table-responsive">
            <table id="engineTable">
                <thead>
                    <tr>
                        <th>名前 (Name)</th>
                        <th>種類 (Type)</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px;">
            <h2 id="saveHeader">保存</h2>
            <p id="saveDesc">編集が終わったらファイルをダウンロードし、元の <code>engines.json</code> に上書きしてください。</p>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button id="saveBtn" class="btn btn-success" onclick="downloadConfig()">engines.json をダウンロード</button>
                <span id="saveStatus" style="margin-left: 10px; font-weight: bold; display: none;"></span>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="engineModal" class="modal">
    <div class="modal-content" style="position:relative;">
        <h3 id="modalTitle">エンジン編集</h3>
        
        <div class="form-group">
            <label>名前 (Name) <span style="color:red">*</span></label>
            <input type="text" id="editName" placeholder="例: YaneuraOu">
        </div>
        <div class="form-group">
            <label>ID (自動生成)</label>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="editId" readonly style="background-color: #e9ecef; color: #6c757d; font-family: monospace;">
                <button class="btn" onclick="regenerateId()" title="IDを再生成">↺</button>
            </div>
        </div>
        <div class="form-group">
            <label>種類 (Type)</label>
            <select id="editType">
                <option value="game">対局 (Game)</option>
                <option value="research">検討 (Research)</option>
                <option value="both">両方 (Both)</option>
            </select>
        </div>
        <div class="form-group">
            <label>実行ファイルのパス (Path) <span style="color:red">*</span></label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="editPath" placeholder="例: C:\Engines\yaneuraou.exe" oninput="cleanPath(this)">
                <button id="browseBtn" class="btn" onclick="browseFile()" style="display:none; white-space:nowrap;">参照...</button>
                <button id="analyzeBtn" class="btn btn-info" onclick="analyzeEngine()" style="display:none; white-space:nowrap;">オプション取得</button>
            </div>
            <div class="hint">
                絶対パス、または engine-wrapper からの相対パス。
                <span id="winHint"><br>
                <b>【ヒント】</b>参照ボタンを使うか、エクスプローラーでファイルを <b>Shift + 右クリック</b> して <b>「パスとしてコピー」</b> できます。</span>
            </div>
        </div>

        <div class="form-group">
            <label>オプション (Options)</label>
            <div id="optionsList"></div>
            <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-sm" onclick="addOptionRow('', '', 'string')">+ 文字列</button>
                <button class="btn btn-sm" onclick="addOptionRow('', 0, 'number')">+ 数値</button>
                <button class="btn btn-sm" onclick="addOptionRow('', true, 'boolean')">+ 真偽値</button>
                <button class="btn btn-sm" onclick="addOptionRow('', 0, 'spin')">+ Spin (数値範囲)</button>
                <button class="btn btn-sm" onclick="addOptionRow('', '', 'combo', [])">+ Combo (選択)</button>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn" onclick="closeModal()">キャンセル</button>
            <button class="btn btn-primary" onclick="saveEngineFromModal()">決定</button>
        </div>
        
        <div id="modalLoading" class="loading-overlay" style="display:none;">
            <div style="text-align:center;">
                <div style="font-size: 2rem;">⏳</div>
                <div>エンジン解析中...</div>
            </div>
        </div>
    </div>
</div>

<script>
    let engines = [];
    let editingIndex = -1;
    let isAppMode = false;

    // --- Initialization ---
    window.addEventListener('DOMContentLoaded', async () => {
        // Try to connect to Python backend
        try {
            const res = await fetch('/api/load');
            if (res.ok) {
                const data = await res.json();
                isAppMode = true;

                // Handle new response format {engines: [], os: 'nt'} or old format []
                if (data && typeof data === 'object' && !Array.isArray(data)) {
                    engines = data.engines || [];
                    const os = data.os;

                    // On non-Windows platforms, remove the Browse button and Windows-specific hints
                    if (os && os !== 'nt') {
                        const browseBtn = document.getElementById('browseBtn');
                        if (browseBtn) browseBtn.remove();
                        const winHint = document.getElementById('winHint');
                        if (winHint) winHint.remove();
                    }
                } else {
                    engines = data;
                }

                enableAppMode();
                renderTable();
                document.getElementById('editorSection').style.display = 'block';
            }
        } catch (e) {
            console.error('Failed to initialize app mode:', e);
            console.log('Running in standalone file mode');
        }
    });

    function enableAppMode() {
        document.getElementById('fileLoadSection').style.display = 'none';
        
        // Update Save section
        document.getElementById('saveHeader').innerText = '保存';
        document.getElementById('saveDesc').innerText = 'ボタンを押すと engines.json に直接保存されます。';
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.innerText = '設定を保存';
        saveBtn.onclick = saveConfigToServer;
        
        // Enable Analyze and Browse buttons
        document.getElementById('analyzeBtn').style.display = 'block';
        const browseBtn = document.getElementById('browseBtn');
        if (browseBtn) browseBtn.style.display = 'block';

        // Add Shutdown button to header area
        const container = document.querySelector('.container');
        const header = container.querySelector('h1');
        
        const shutdownBtn = document.createElement('button');
        shutdownBtn.innerText = '終了';
        shutdownBtn.className = 'btn btn-danger btn-sm';
        shutdownBtn.style.float = 'right';
        shutdownBtn.onclick = terminateServer;
        
        header.insertBefore(shutdownBtn, header.firstChild);
    }

    async function browseFile() {
        try {
            const res = await fetch('/api/browse', {method: 'POST'});
            const data = await res.json();
            if (data.status === 'ok' && data.path) {
                document.getElementById('editPath').value = data.path;
            }
        } catch (e) {
            alert('ファイル選択エラー: ' + e.message);
        }
    }

    async function terminateServer() {
        if (!confirm('設定ツールを終了しますか？\n(保存していない変更は破棄されます)')) return;
        
        try {
            await fetch('/api/shutdown', {method: 'POST'});
        } catch(e) {
            // Ignore network error as server dies
        }
        
        document.body.innerHTML = `
            <div style="display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column; text-align:center;">
                <h2 style="color:var(--success)">終了しました</h2>
                <p>この画面を閉じてください。</p>
            </div>
        `;
    }

    // --- File Mode Handlers ---
    const fileInput = document.getElementById('fileInput');
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                engines = JSON.parse(e.target.result);
                if (!Array.isArray(engines)) throw new Error('Root must be an array');
                renderTable();
                document.getElementById('editorSection').style.display = 'block';
            } catch (err) {
                alert('JSONの読み込みに失敗しました: ' + err.message);
            }
        };
        reader.readAsText(file);
    });

    function startNew() {
        if (confirm('現在の編集内容を破棄して新規作成しますか？')) {
            engines = [];
            renderTable();
            document.getElementById('editorSection').style.display = 'block';
            fileInput.value = '';
        }
    }

    // --- Main Logic ---

    function generateUlid() {
        const ENCODING = "0123456789ABCDEFGHJKMNPQRSTVWXYZ";
        const TIME_LEN = 10;
        const RANDOM_LEN = 16;
        
        let time = Date.now();
        let s = "";
        
        // Timestamp (48-bit)
        for (let i = TIME_LEN; i > 0; i--) {
            const mod = time % 32;
            s = ENCODING.charAt(mod) + s;
            time = (time - mod) / 32;
        }
        
        // Randomness (80-bit)
        const randomValues = new Uint8Array(RANDOM_LEN);
        crypto.getRandomValues(randomValues);
        
        for (let i = 0; i < RANDOM_LEN; i++) {
            // Simple mapping to base32 char
            s += ENCODING.charAt(randomValues[i] % 32);
        }
        
        return s;
    }

    function generateId() {
        return generateUlid();
    }

    function regenerateId() {
        if (confirm('IDを再生成しますか？\n（通常は変更する必要はありません）')) {
            document.getElementById('editId').value = generateId();
        }
    }

    function renderTable() {
        const tbody = document.querySelector('#engineTable tbody');
        tbody.innerHTML = '';
        engines.forEach((eng, idx) => {
            const tr = document.createElement('tr');
            
            // Move buttons logic
            const isFirst = idx === 0;
            const isLast = idx === engines.length - 1;
            const upBtn = `<button class="btn btn-sm" onclick="moveEngine(${idx}, -1)" ${isFirst?'disabled':''} style="padding:2px 6px;">↑</button>`;
            const downBtn = `<button class="btn btn-sm" onclick="moveEngine(${idx}, 1)" ${isLast?'disabled':''} style="padding:2px 6px;">↓</button>`;

            tr.innerHTML = `
                <td>${escapeHtml(eng.name)}</td>
                <td>${escapeHtml(eng.type)}</td>
                <td>
                    ${upBtn} ${downBtn}
                    <button class="btn btn-sm btn-info" onclick="duplicateEngine(${idx})">複製</button>
                    <button class="btn btn-sm btn-primary" onclick="editEngine(${idx})">編集</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteEngine(${idx})">削除</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function moveEngine(index, direction) {
        if (direction === -1 && index > 0) {
            // Swap with previous
            [engines[index], engines[index-1]] = [engines[index-1], engines[index]];
        } else if (direction === 1 && index < engines.length - 1) {
            // Swap with next
            [engines[index], engines[index+1]] = [engines[index+1], engines[index]];
        }
        renderTable();
    }

    function openEngineModal(index = -1) {
        editingIndex = index;
        const modal = document.getElementById('engineModal');
        const list = document.getElementById('optionsList');
        list.innerHTML = '';

        if (index >= 0) {
            // Edit existing
            document.getElementById('modalTitle').innerText = 'エンジン編集';
            const eng = engines[index];
            document.getElementById('editName').value = eng.name || '';
            document.getElementById('editId').value = eng.id || generateId(); // Fallback if missing
            document.getElementById('editType').value = eng.type || 'game';
            document.getElementById('editPath').value = eng.path || '';
            
            // Options
            if (eng.options) {
                Object.entries(eng.options).forEach(([k, v]) => {
                    // Infer type or use stored metadata if we had it (we don't store types in JSON usually, just values)
                    // We try to guess better.
                    let type = 'string';
                    let extra = null;

                    if (typeof v === 'boolean') type = 'boolean';
                    else if (typeof v === 'number') type = 'number';
                    else if (typeof v === 'object' && v !== null && v.value !== undefined) {
                        // We'll treat them as simple types.
                    }
                    
                    addOptionRow(k, v, type);
                });
            }
        } else {
            // New
            document.getElementById('modalTitle').innerText = 'エンジン追加';
            document.getElementById('editName').value = '';
            document.getElementById('editId').value = generateId();
            document.getElementById('editType').value = 'game';
            document.getElementById('editPath').value = '';
        }

        modal.style.display = 'block';
    }

    function closeModal() {
        document.getElementById('engineModal').style.display = 'none';
    }

    async function analyzeEngine() {
        const path = document.getElementById('editPath').value;
        if (!path) {
            alert('パスを入力してください。');
            return;
        }
        
        document.getElementById('modalLoading').style.display = 'flex';
        
        try {
            const res = await fetch('/api/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({path})
            });
            const data = await res.json();
            
            if (!res.ok) throw new Error(data.error || 'Unknown error');
            
            // Success, populate options
            const options = data.options || {};
            
            // Backup current values from DOM to preserve user edits
            const currentValues = {};
            document.querySelectorAll('#optionsList .option-row').forEach(row => {
                const key = row.querySelector('.opt-key').value.trim();
                const input = row.querySelector('.opt-val');
                if (key) {
                    if (row.dataset.type === 'boolean') currentValues[key] = input.checked;
                    else if (row.dataset.type === 'number' || row.dataset.type === 'spin') currentValues[key] = Number(input.value);
                    else currentValues[key] = input.value;
                }
            });

            const list = document.getElementById('optionsList');
            list.innerHTML = ''; // Clear existing
            
            Object.keys(options).forEach(name => {
                const opt = options[name];
                let val = opt.default;
                
                // Use existing value if available (Priority: Current Input > Saved JSON > Default)
                if (currentValues.hasOwnProperty(name)) {
                    val = currentValues[name];
                } else if (editingIndex >= 0 && engines[editingIndex].options && engines[editingIndex].options[name] !== undefined) {
                    val = engines[editingIndex].options[name];
                }
                
                let type = 'string';
                let extra = {};
                
                if (opt.type === 'check') type = 'boolean';
                else if (opt.type === 'spin') {
                    type = 'spin';
                    extra = {min: opt.min, max: opt.max};
                }
                else if (opt.type === 'combo') {
                    type = 'combo';
                    extra = {vars: opt.vars || []};
                }
                else if (opt.type === 'button') return; // Skip buttons
                
                // If it's a new engine, use default. 
                // If we are editing and re-analyzing, maybe preserve current values?
                // For now, overwrite with defaults from engine is safer to ensure valid set.
                addOptionRow(name, val, type, extra);
            });
            
            alert(`取得成功: ${Object.keys(options).length} 個のオプションが見つかりました。`);
            
        } catch (e) {
            alert('解析失敗: ' + e.message);
        } finally {
            document.getElementById('modalLoading').style.display = 'none';
        }
    }

    function addOptionRow(key = '', val = '', type = 'string', extra = {}) {
        const list = document.getElementById('optionsList');
        const div = document.createElement('div');
        div.className = 'option-row';
        div.dataset.type = type;
        // Store extra data for spin/combo
        if (extra) div.dataset.extra = JSON.stringify(extra);

        let typeLabelText = {string: '文字', number: '数値', boolean: '真偽', spin: '数値(範囲)', combo: '選択'}[type] || type;

        // Create Name input
        const keyInput = document.createElement('input');
        keyInput.type = 'text';
        keyInput.placeholder = '名前';
        keyInput.value = key;
        keyInput.className = 'opt-key';
        div.appendChild(keyInput);

        // Container for Value input
        const valContainer = document.createElement('div');
        valContainer.className = 'opt-val-container';

        if (type === 'boolean') {
            const isChecked = val === true || String(val) === 'true';
            valContainer.style.background = '#fff';
            valContainer.style.border = '1px solid var(--border)';
            valContainer.style.padding = '5px';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'opt-val';
            checkbox.checked = isChecked;
            checkbox.style.width = 'auto';

            const label = document.createElement('span');
            label.className = 'bool-label';
            label.textContent = isChecked ? 'true' : 'false';

            checkbox.addEventListener('change', (e) => {
                label.textContent = e.target.checked ? 'true' : 'false';
            });

            valContainer.appendChild(checkbox);
            valContainer.appendChild(label);
        } else if (type === 'spin') {
            const min = extra.min !== undefined ? extra.min : 0;
            const max = extra.max !== undefined ? extra.max : 999999;

            const spinInput = document.createElement('input');
            spinInput.type = 'number';
            spinInput.className = 'opt-val';
            spinInput.value = val;
            spinInput.min = min;
            spinInput.max = max;

            const rangeLabel = document.createElement('span');
            rangeLabel.style.fontSize = '0.8rem';
            rangeLabel.style.color = '#666';
            rangeLabel.textContent = `(${min}~${max})`;

            valContainer.appendChild(spinInput);
            valContainer.appendChild(rangeLabel);
        } else if (type === 'combo') {
            const select = document.createElement('select');
            select.className = 'opt-val';
            const vars = extra.vars || [];
            vars.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                if (v == val) opt.selected = true;
                select.appendChild(opt);
            });
            valContainer.appendChild(select);
        } else if (type === 'number') {
            const numInput = document.createElement('input');
            numInput.type = 'number';
            numInput.className = 'opt-val';
            numInput.value = val;
            valContainer.appendChild(numInput);
        } else {
            const textInput = document.createElement('input');
            textInput.type = 'text';
            textInput.className = 'opt-val';
            textInput.value = val;
            valContainer.appendChild(textInput);
        }
        div.appendChild(valContainer);

        // Type Label
        const typeLabel = document.createElement('span');
        typeLabel.style.fontSize = '0.8rem';
        typeLabel.style.background = '#eee';
        typeLabel.style.padding = '2px 6px';
        typeLabel.style.borderRadius = '4px';
        typeLabel.style.whiteSpace = 'nowrap';
        typeLabel.style.flexShrink = '0';
        typeLabel.style.minWidth = '60px';
        typeLabel.style.textAlign = 'center';
        typeLabel.textContent = typeLabelText;
        div.appendChild(typeLabel);

        // Delete button
        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-sm btn-danger';
        delBtn.textContent = '×';
        delBtn.onclick = () => div.remove();
        div.appendChild(delBtn);

        list.appendChild(div);
    }

    function saveEngineFromModal() {
        const name = document.getElementById('editName').value.trim();
        const id = document.getElementById('editId').value.trim();
        const path = document.getElementById('editPath').value.trim();
        const type = document.getElementById('editType').value;

        if (!name || !id || !path) {
            alert('名前、ID、パスは必須です。');
            return;
        }

        const options = {};
        document.querySelectorAll('#optionsList .option-row').forEach(row => {
            const key = row.querySelector('.opt-key').value.trim();
            if (!key) return; 

            const type = row.dataset.type;
            const input = row.querySelector('.opt-val');
            let val;

            if (type === 'boolean') {
                val = input.checked;
            } else if (type === 'number' || type === 'spin') {
                val = Number(input.value);
            } else {
                val = input.value;
            }
            options[key] = val;
        });

        const newEngine = { id, name, type, path, options };

        if (editingIndex >= 0) {
            engines[editingIndex] = newEngine;
        } else {
            if (engines.some(e => e.id === id)) {
                alert('このIDは既に使用されています: ' + id);
                return;
            }
            engines.push(newEngine);
        }

        renderTable();
        closeModal();
    }

    // --- Saving ---

    function downloadConfig() {
        if (engines.length === 0) {
            alert('エンジンが1つも登録されていません。');
            return;
        }
        const jsonStr = JSON.stringify(engines, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'engines.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    async function saveConfigToServer() {
        const btn = document.getElementById('saveBtn');
        const status = document.getElementById('saveStatus');
        
        btn.disabled = true;
        status.innerText = '保存中...';
        status.style.display = 'inline';
        status.style.color = '#666';

        try {
            const res = await fetch('/api/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(engines)
            });
            if (!res.ok) throw new Error('Server returned error');
            
            status.innerText = '保存完了！';
            status.style.color = 'var(--success)';
            setTimeout(() => { status.style.display = 'none'; }, 2000);
            
        } catch (e) {
            alert('保存に失敗しました: ' + e.message);
            status.innerText = '保存失敗';
            status.style.color = 'var(--danger)';
        } finally {
            btn.disabled = false;
        }
    }

    // --- Helpers ---

    function duplicateEngine(index) {
        if (index < 0 || index >= engines.length) return;
        
        // Deep copy
        const source = engines[index];
        const newEngine = JSON.parse(JSON.stringify(source));
        
        // Modify name and ID to avoid conflicts
        newEngine.name = newEngine.name + ' (Copy)';
        newEngine.id = generateId();
        
        // Insert after the original
        engines.splice(index + 1, 0, newEngine);
        renderTable();
    }

    function deleteEngine(index) {
        if (confirm('本当に削除しますか？')) {
            engines.splice(index, 1);
            renderTable();
        }
    }
    
    function editEngine(index) {
        openEngineModal(index);
    }

    function cleanPath(input) {
        const cleaned = input.value.replace(/"/g, '');
        if (cleaned !== input.value) {
            input.value = cleaned;
        }
    }

    function escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return '';
        return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    window.onclick = function(event) {
        const modal = document.getElementById('engineModal');
        if (event.target == modal) {
            closeModal();
        }
    }
</script>

</body>
</html>
