ShogiHome LAN Engine - ユーザーガイド

本ソフトウェアは、ShogiHome (https://github.com/sunfish-shogi/shogihome) をフォークし、
LAN内でのリモートエンジン利用機能を追加した派生版です。

このツールを使うと、PCの強力な将棋エンジンを、
同じWi-Fiにつながっているスマートフォンやタブレットから利用できるようになります。

==================================================================
【重要】セキュリティに関する注意
このツールは、自宅のWi-Fiなど「信頼できるネットワーク内」での利用を前提としています。
インターネットに直接公開するサーバー等では使用しないでください。
==================================================================

■ 1. 準備するもの

1.  このフォルダ一式（解凍済み）
2.  使いたい将棋エンジン

■ 2. 最初の設定

1.  将棋エンジンの配置
    エンジンの実行ファイルと評価関数を任意のフォルダに用意してください。

2.  サーバー設定の確認（通常は設定不要）
    本バージョンでは、サーバーのIPアドレスを自動検出し、LAN内からのアクセスを
    自動的に許可する機能が搭載されています。
    そのため、標準的な利用（自宅Wi-Fi等）では設定ファイルを編集する必要はありません。

    ※ 以下の場合は、「shogihome」フォルダの「.env」ファイルを編集してください。

       - 自動許可を無効化する場合
       - エンジンの切断保護時間を変更する場合

       --------------------------------------------------
       # 接続を許可するオリジン（自動設定を上書きする場合）
       ALLOWED_ORIGINS=http://localhost:8140,http://192.168.1.10:8140
       
       # 自動許可機能を無効化する場合
       DISABLE_AUTO_ALLOWED_ORIGINS=true

       # (オプション) エンジンの切断保護時間（秒）
       # 一時的な通信断が発生しても、ここで設定した時間はエンジンを維持します。デフォルトは60秒です。
       ENGINE_CONNECTION_PROTECTION_TIMEOUT=60
       --------------------------------------------------

■ 3. 使い方

1.  起動する
    一番上のフォルダにある「ShogiHomeLAN.exe」をダブルクリックしてください。
    ランチャーが起動し、自動的にWebサーバーとエンジンラッパーがバックグラウンドで開始されます。

    【重要】「WindowsによってPCが保護されました」と表示される場合
    インターネットからダウンロードした未署名のアプリを実行すると、青色の警告画面（SmartScreen）が表示されることがあります。
    その場合は「詳細情報」をクリックすると「実行」ボタンが表示されます。

    【重要】初回起動時の許可について
    起動時に「Windows セキュリティ」のポップアップが表示された場合は、
    「プライベート ネットワーク」にチェックを入れて「アクセスを許可する」を押してください。
    ※現在のWi-Fiが「パブリック」設定になっていると通信できません。Windowsの設定から
      接続中のネットワークを「プライベート」に変更することを推奨します。
    
2.  エンジンの登録と設定
    ランチャーが起動したら「Engine Settings」クリックしてください。
    ブラウザが開き、エンジン設定の画面が表示されます。

    (1) 「＋エンジン追加」ボタンから実行ファイルを選択し、エンジンを登録します。
    (2) 「オプション取得」ボタンを使うと、エンジンのオプションを自動で読み込めます。
    (3) オプションの設定を終えたら「決定」をクリックしてください。
    (4) エンジンの登録と設定が完了したら「設定を保存」し、「終了」をクリックしてエディタを閉じます。

3.  スマホから使う
    ランチャーに表示されているQRコードを読み取るか、URL（例: http://192.168.1.10:8140）を
    直接スマホのブラウザに入力してアクセスします。
    「検討」や「対局」をクリックして、先ほど登録したエンジンが表示されることを確認してください。

    【機能】接続の維持と自動再開について
    本アプリは、電波状況の悪い場所での利用やアプリのバックグラウンドへの移行を考慮し、
    通信が切断されても一定時間はエンジンをサーバー側で維持します。
    
    - 電波状況等によりエンジンとの接続が一時的に切れた場合、切断を検知して再接続を試みます。
    - エンジン起動中にアプリをバックグラウンドにした場合、フォアグラウンド復帰時に自動で再接続します。
    - 明示的に検討・対局を終了した場合のみ、即座にエンジンが終了します。

■ 4. 終了方法

1.  ランチャーの「Stop & Exit」ボタンをクリックしてください。
    バックグラウンドで動作しているすべてのプロセスを終了して閉じます。

    ※ ウィンドウ右上の「×」ボタンで閉じると、タスクトレイに常駐します。
       完全に終了させるには「Stop & Exit」を使用するか、タスクトレイアイコンから「Exit」を選択してください。

■ 5. トラブルシューティング

Q. 画面が開かない / スマホからつながらない
A. 以下の2点を確認してください。

    1. Windowsのファイアウォール設定
       初回起動時のポップアップで「許可」をしなかった場合、通信がブロックされます。
       手動でWindowsファイアウォールの設定（「アプリにファイアウォール経由の通信を許可する」）を開き、
       「shogihome-server.exe」の通信を「プライベート」で許可してください。

    2. ネットワークの違い（二重ルーター等）
       PCとスマホが論理的に同じネットワークにいない可能性があります。
       PCとスマホのIPアドレスを見比べ、上3つの数字（例: 192.168.1.xxx の "192.168.1" 部分）が一致しているか確認してください。
       一致していない場合、二重ルーター環境などが原因で通信できない状態です。PCと同じWi-Fiにスマホを接続し直してみてください。

Q. エンジンが動かない / 検討ボタンを押しても反応がない
A. まず、サーバーを起動したPCのブラウザで「http://localhost:8140」にアクセスして検討ボタンを押してみてください。

    → ローカル（PC）では動くが、スマホからは動かない場合
    PCのIPアドレスが正しく認識されていない可能性があります。
    ランチャーに表示されているURLのIPアドレスが、スマホからアクセスしようとしている
    ネットワークのものと一致しているか確認してください。
    詳細は、ランチャーの「Show Logs」からサーバーログを開き、「Auto-detected local IPs」
    のメッセージを確認することで判断できます。

    → ローカル（PC）でも動かない場合
    エンジンのパス設定が正しいか、ランチャーの「Show Logs」から「Wrapper Log」を確認してください。
    パスの間違いや、エンジン実行に必要なファイル（評価関数等）の不足がある場合に
    エラーメッセージが表示されます。

■ 6. 応用

1.  インターネット経由でのアクセス (Tailscale)
    Tailscale(https://tailscale.com/download) を利用して、外部から安全にアクセスできます。

    1.  サーバーPCとクライアントにTailscaleをインストールし、同一アカウントでログインします。
    2.  Tailscaleが割り当てたサーバーPCのIPアドレス (100.x.x.x) を確認します。
    3.  サーバーを起動します（TailscaleのIPは通常、自動的に認識・許可されます）。
    4.  クライアントから http://<TailscaleのIPアドレス>:8140 にアクセスします。

    ※ もし接続できない場合は、「2-2. サーバー設定の編集」の手順で ALLOWED_ORIGINS に http://<TailscaleのIPアドレス>:8140 を追加してください。

2.  HTTPS化とPWA化 (Tailscale Serve)
    tailscale serve を使うと、HTTPS化されたURLが発行され、PWAとしてホーム画面に追加できます。
    (この場合は、ブラウザが送信するOriginが https になるため、手動設定が必要です)

    1.  Tailscale の AdminConsole で、「MagicDNS」と「HTTPS Certificates」を有効にします。

    2.  サーバーPCのターミナルで、以下のコマンドを実行します。
        --------------------------------------------------
        tailscale serve --bg 8140
        --------------------------------------------------

    3.  表示されたURL https://<hostname>.<tailnet>.ts.net を ALLOWED_ORIGINS に追加します。
        --------------------------------------------------
        ALLOWED_ORIGINS=https://<hostname>.<tailnet>.ts.net
        --------------------------------------------------

    4.  (推奨) セキュリティを高めるため、自動許可を無効化し Tailscale 経由のみに限定します。
        「shogihome」フォルダの「.env」ファイルに以下を記述してください。
        --------------------------------------------------
        BIND_ADDRESS=127.0.0.1
        DISABLE_AUTO_ALLOWED_ORIGINS=true
        --------------------------------------------------

    5.  サーバーを再起動します。
    6.  https://<hostname>.<tailnet>.ts.net にクライアントからアクセスし、「ホーム画面に追加」します。

==================================================================
【ライセンスと免責事項】
本ソフトウェアは MIT ライセンスの下で提供されるオープンソースソフトウェアです。
個人・商用を問わず無償でご利用いただけますが、使用した結果生じたいかなる損害
（PCの不調、データの消失、通信トラブル等）についても、開発者は責任を負いません。
自己責任のもとご利用ください。

詳細なライセンス全文やソースコードは GitHub をご覧ください。
https://github.com/yoset77/shogihome-lan

