ShogiHome LAN Engine - ユーザーガイド

本ソフトウェアは、ShogiHome (https://github.com/sunfish-shogi/shogihome) をフォークし、
LAN内でのリモートエンジン利用機能を追加した派生版です。

このツールを使うと、PCの強力な将棋エンジンを、
同じWi-Fiにつながっているスマートフォンやタブレットから利用できるようになります。

==================================================================
【重要】セキュリティに関する注意
このツールは、自宅のWi-Fiなど「信頼できるネットワーク内」での利用を前提としています。
インターネットに直接公開するサーバー等では使用しないでください。
==================================================================

■ 1. 準備するもの

1.  このフォルダ一式（解凍済み）
2.  使いたい将棋エンジン

■ 2. 最初の設定

1.  将棋エンジンの配置
    エンジンの実行ファイルと評価関数を任意のフォルダに用意してください。

2.  設定ファイルの編集

    1. 「engine-wrapper」フォルダの中にある「engines.json」ファイルを、テキストエディタで開いて編集します。

       "id": 識別子です。
       "name": UI上に表示される名前です。
       "type": "research" "game" "both" のいずれかを指定してください。
       "path": エンジンのパスを記述してください。
       "options": エンジン起動時に送信するオプション名と設定値を記述します。デフォルト値のままでよいオプションは記述不要です。

       ※ 検討エンジンの「MultiPV」はUIから設定できます。

       ※ Windowsのパス（¥マークやバックスラッシュ）は、JSONファイル内では
          2つ重ねて記述するか（例: C:\\Shogi\\Engine.exe）、
          スラッシュに置き換えて記述してください（例: C:/Shogi/Engine.exe）。
             
       ※ JSONは文法が厳格に決まっているので、ブラウザ上のツールで文法をチェックするか、VS Code などの高機能エディタを使用してください。
    
    2. 「shogihome」フォルダの「.env」ファイルも同様にテキストエディタで編集します。
       以下の行を、ご自身のPCのIPアドレスに合わせて書き換えてください。
　　　 --------------------------------------------------
　　   # 接続を許可するオリジン（URLの一部）
       # 以下の設定は一例です
       # 複数のオリジンを記述する場合は、スペースを入れずに「,」で区切ってください
       ALLOWED_ORIGINS=http://localhost:8080,http://192.168.1.10:8080
       
       # (オプション) エンジンの切断保護時間（秒）
       # 一時的な通信断が発生しても、ここで設定した時間はエンジンを維持します。デフォルトは60秒です。
       ENGINE_CONNECTION_PROTECTION_TIMEOUT=60
       --------------------------------------------------

■ 3. 使い方

1.  起動する
    一番上のフォルダにある「start.bat」をダブルクリックしてください。
    黒い画面が開き、サーバーが起動します。

    【重要】「WindowsによってPCが保護されました」と表示される場合
    インターネットからダウンロードした未署名のアプリを実行すると、青色の警告画面（SmartScreen）が表示されることがあります。
    その場合は「詳細情報」をクリックすると「実行」ボタンが表示されます。

    【重要】初回起動時の許可について
    起動時に「Windows セキュリティ」のポップアップが表示された場合は、
    「プライベート ネットワーク」にチェックを入れて「アクセスを許可する」を押してください。
    ※現在のWi-Fiが「パブリック」設定になっていると通信できません。Windowsの設定から
      接続中のネットワークを「プライベート」に変更することを推奨します。

    【機能】接続の維持と自動再開について
    本アプリは、電波状況の悪い場所での利用やアプリのバックグラウンドへの移行を考慮し、
    通信が切断されても一定時間はエンジンをサーバー側で維持します。
    
    - 電波状況等によりエンジンとの接続が一時的に切れた場合、切断を検知して再接続を試みます。
　　- エンジン起動中にアプリをバックグラウンドにした場合、フォアグラウンド復帰時に自動で再接続します。
    - 明示的に検討・対局を終了した場合のみ、即座にエンジンが終了します。

2.  スマホから使う
    PCと同じWi-Fiにつながっているスマホのブラウザ（ChromeやSafari）を開き、
    PCのIPアドレスを入力してアクセスします。
    スマホからアクセスした場合はモバイル版が表示されます。（PC版が表示されてしまった場合は、URLの末尾に「/?mobile」を付けてください）

    URLの例: http://192.168.1.10:8080/?mobile

■ 4. 終了方法

1.  起動時に開いた黒い画面（Web Server）を選択します。
2.  キーボードの「Ctrl」キーを押しながら「C」キーを押します。
    （または、単純にウィンドウの「×」ボタンで閉じてしまっても構いません）

■ 5. トラブルシューティング

Q. 画面が開かない / スマホからつながらない
A. 以下の2点を確認してください。

   1. Windowsのファイアウォール設定
      初回起動時のポップアップで「許可」をしなかった場合、通信がブロックされます。
      手動でWindowsファイアウォールの設定（「アプリにファイアウォール経由の通信を許可する」）を開き、
      「shogihome-server.exe」の通信を「プライベート」で許可してください。

   2. ネットワークの違い（二重ルーター等）
      PCとスマホが論理的に同じネットワークにいない可能性があります。
      PCとスマホのIPアドレスを見比べ、上3つの数字（例: 192.168.1.xxx の "192.168.1" 部分）が一致しているか確認してください。
      一致していない場合、二重ルーター環境などが原因で通信できない状態です。PCと同じWi-Fiにスマホを接続し直してみてください。

Q. エンジンが動かない / 検討ボタンを押しても反応がない
A. まず、サーバーを起動したPCのブラウザで「http://localhost:8080」にアクセスして検討ボタンを押してみてください。

   → ローカル（PC）では動くが、スマホからは動かない場合
   PCのIPアドレスと、「ALLOWED_ORIGINS」に書いたIPアドレスが一致しているか確認してください。

   → ローカル（PC）でも動かない場合
   「engine-wrapper」フォルダ内の「engines.json」の文法とエンジンのパスが正しいか確認してください。
   また、エンジンファイル（.exe）をダブルクリックして単体で起動できるか確認してください。
   「engine-wrapper」フォルダ内に生成される「engine-wrapper.log」ファイルにエラーの詳細が出力されている場合があるため、そちらもご確認ください。

■ 6. 応用

1.  インターネット経由でのアクセス (Tailscale)
    Tailscale(https://tailscale.com/download) を利用して、外部から安全にアクセスできます。

    1.  サーバーPCとクライアントにTailscaleをインストールし、同一アカウントでログインします。
    2.  Tailscaleが割り当てたサーバーPCのIPアドレス (100.x.x.x) を確認します。
    3.  ALLOWED_ORIGINS に、http://<TailscaleのIPアドレス>:8080 を追加します。
    4.  サーバーを再起動します。
    5.  クライアントから http://<TailscaleのIPアドレス>:8080 にアクセスします。

2.  HTTPS化とPWA化 (Tailscale Serve)
    tailscale serve を使うと、HTTPS化されたURLが発行され、PWAとしてホーム画面に追加できます。

    1.  Tailscale の AdminConsole で、「MagicDNS」と「HTTPS Certificates」を有効にします。

    2.  サーバーPCのターミナルで、以下のコマンドを実行します。
        --------------------------------------------------
        tailscale serve --bg 8080
        --------------------------------------------------

    3.  表示されたURL https://<hostname>.<tailnet>.ts.net を ALLOWED_ORIGINS に追加します。
        --------------------------------------------------
        ALLOWED_ORIGINS=http://localhost:8080,https://<hostname>.<tailnet>.ts.net
        --------------------------------------------------

    4.  (推奨)「shogihome」フォルダの「.env」ファイルに以下の行を追加することで、Tailscale経由のアクセスに限定できます。
        --------------------------------------------------
        BIND_ADDRESS=127.0.0.1
        --------------------------------------------------

    5.  サーバーを再起動します。
    6.  https://<hostname>.<tailnet>.ts.net にクライアントからアクセスし、「ホーム画面に追加」します。

==================================================================
【ライセンスと免責事項】
本ソフトウェアは MIT ライセンスの下で提供されるオープンソースソフトウェアです。
個人・商用を問わず無償でご利用いただけますが、使用した結果生じたいかなる損害
（PCの不調、データの消失、通信トラブル等）についても、開発者は責任を負いません。
自己責任のもとご利用ください。

詳細なライセンス全文やソースコードは GitHub をご覧ください。
https://github.com/yoset77/shogihome-lan

